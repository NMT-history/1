<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowmap</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- Глобальные переменные и стили --- */
        :root {
            --black: #000000;
            --dark-grey: #1a1a1a;
            --medium-grey: #2b2b2b;
            --light-grey: #555555;
            --font-grey: #b3b3b3;
            --white: #ffffff;
            --red: #e54040;
            --red-hover: #ff5050;
            --delete-red: #521c1c;
            --delete-red-hover: #6a2323;

            --priority-red: rgba(229, 64, 64, 0.4);
            --priority-blue: rgba(64, 126, 229, 0.4);
            --priority-green: rgba(64, 229, 106, 0.4);
            --priority-yellow: rgba(229, 212, 64, 0.4);
            --priority-none: transparent;

            --q1-color: #9b59b6; /* Фиолетовый */
            --q2-color: #3498db; /* Синий */
            --q3-color: #2ecc71; /* Зеленый */
            --q4-color: #e67e22; /* Оранжевый */
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--black);
            color: var(--white);
            overflow: hidden;
        }

        .app-wrapper {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* --- Боковая панель --- */
        .sidebar {
            width: 60px;
            background-color: var(--black);
            border-right: 1px solid var(--medium-grey);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            flex-shrink: 0;
        }

        .sidebar-link {
            cursor: pointer;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .sidebar-link svg {
            width: 24px;
            height: 24px;
            fill: var(--font-grey);
            transition: fill 0.2s;
        }

        .sidebar-link:hover {
            background-color: var(--medium-grey);
        }

        .sidebar-link.active svg {
            fill: var(--white);
        }

        /* --- Основной контент --- */
        .main-content {
            flex-grow: 1;
            padding: 25px 35px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .view {
            display: none;
            flex-grow: 1;
        }

        #year-view.active { /* Specific layout for year view */
            display: flex;
            flex-direction: row;
            gap: 20px;
        }

        #year-view.active .year-content-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .view.active:not(#year-view) { /* All other views */
            display: block;
        }

        .view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .view-title {
            font-size: 28px;
            font-weight: 600;
        }

        .nav-buttons button, .nav-buttons select {
            background: none;
            border: 1px solid var(--medium-grey);
            color: var(--white);
            padding: 8px 12px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 6px;
            margin-left: 10px;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .nav-buttons button:hover, .nav-buttons select:hover {
            background-color: var(--medium-grey);
        }
        .nav-buttons select option {
            background-color: var(--dark-grey);
            color: var(--white);
        }

        /* --- Вид "Месяц" --- */
        #month-view .calendar-grid-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: var(--light-grey);
        }
        #month-view .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: var(--light-grey);
            border: 1px solid var(--light-grey);
            border-top: none;
        }

        .calendar-header {
            background-color: var(--black);
            text-align: center;
            padding: 10px 0;
            font-weight: 600;
            color: var(--font-grey);
        }

        .calendar-day {
            background-color: var(--dark-grey);
            min-height: 150px;
            padding: 8px;
            position: relative;
            display: flex;
            flex-direction: column;
            cursor: pointer;
        }

        .calendar-day.other-month {
            background-color: #111;
            cursor: default;
        }

        .calendar-day.weekend:not(.other-month) {
            background-color: #0d0d0d;
        }

        .day-number {
            font-weight: 500;
            margin-bottom: 10px;
            text-align: left;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .calendar-day.today .day-number {
            background-color: var(--red);
            color: var(--white);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .day-tasks {
            flex-grow: 1;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 4px;
            font-size: 14px;
            border-bottom: 1px dotted var(--medium-grey);
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 3px;
        }

        .task-item.completed .task-title {
            text-decoration: line-through;
            color: var(--light-grey);
        }

        .task-checkbox {
            width: 14px;
            height: 14px;
            border: 1px solid var(--light-grey);
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
            cursor: pointer;
        }

        .task-item.completed .task-checkbox {
            background-color: var(--red);
            border-color: var(--red);
        }

        /* --- Вид "Год" --- */
        #year-view .year-content-wrapper {
             flex-grow: 1;
        }
        #year-view .year-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            flex-grow: 1;
        }

        .month-card {
            padding: 15px;
            background-color: var(--dark-grey);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }

        .month-card-title {
            text-align: center;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .month-days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            font-size: 11px;
        }

        .month-days-grid span { /* Headers like Пн, Вт */
            text-align: center;
            padding: 3px;
            border-radius: 3px;
            cursor: default;
        }

        .month-day-cell { /* Individual day cells */
            border-radius: 4px;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.1s, outline 0.1s;
            cursor: pointer;
            position: relative; /* For pseudo-elements if needed for selection */
        }
        .month-day-cell:hover:not(.empty-day) {
            transform: scale(1.1);
            background-color: var(--medium-grey);
        }
        .month-day-cell.empty-day {
            cursor: default;
            opacity: 0;
        }

        .month-day-cell.today {
            background-color: var(--red);
            color: var(--white);
            font-weight: bold;
        }
        .month-day-cell.selected-priority { /* Style for days with priority set */
             /* background is set dynamically by JS */
        }
        .month-day-cell.multi-selected {
            outline: 2px solid var(--red);
            outline-offset: 1px;
            /* background-color: var(--medium-grey) !important; /* Ensure highlight is visible over priority */
            /* filter: brightness(1.3); */ /* Another way to show selection */
        }


        #year-goals-panel {
            width: 300px;
            flex-shrink: 0;
            background-color: var(--dark-grey);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        #year-goals-panel h3 {
            margin-top: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--font-grey);
            border-bottom: 1px solid var(--medium-grey);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .goals-list-container { /* For #year-goals-list-container */
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            background-color: var(--medium-grey);
            border-radius: 6px;
            padding: 10px;
            min-height: 100px; /* Ensure it has some height even if empty */
        }

        .goal-item {
            display: flex;
            align-items: center;
            padding: 8px 5px;
            font-size: 14px;
            border-bottom: 1px solid var(--light-grey); /* Separator */
            border-radius: 4px;
            margin-bottom: 5px;
            background-color: var(--dark-grey); /* Background for the goal item itself */
        }
        .goal-item:last-child {
            border-bottom: none;
        }

        .goal-item.completed .goal-text {
            text-decoration: line-through;
            color: var(--light-grey);
        }

        .goal-checkbox {
            width: 16px;
            height: 16px;
            border: 1px solid var(--light-grey);
            border-radius: 4px; /* Square checkbox */
            margin-right: 10px;
            flex-shrink: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .goal-item.completed .goal-checkbox {
            background-color: var(--red);
            border-color: var(--red);
        }
        .goal-checkbox::after { /* Checkmark */
            content: '✔';
            font-size: 12px;
            color: var(--white);
            display: none; /* Hidden by default */
        }
        .goal-item.completed .goal-checkbox::after {
            display: inline; /* Show when completed */
        }
        .goal-text {
            flex-grow: 1;
            word-break: break-word; /* Prevent long text from overflowing */
        }
        .goal-delete-btn {
            background: none;
            border: none;
            color: var(--font-grey);
            cursor: pointer;
            font-size: 18px; /* Make it a bit larger */
            padding: 0 5px;
            margin-left: 5px;
        }
        .goal-delete-btn:hover {
            color: var(--red);
        }
        #new-year-goal-input { /* Style for the input field */
             margin-bottom: 10px; /* Space before button */
        }


        /* --- Вид "Статистика" --- */
        #stats-view .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .stat-card {
            background-color: var(--dark-grey);
            padding: 20px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            /* min-height: 350px; /* Optional: if you want a fixed minimum height for cards */
        }

        .stat-card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            flex-shrink: 0; /* Title should not shrink */
        }

        .chart-container { /* New class for chart wrapper */
            position: relative; /* Important for Chart.js responsiveness */
            flex-grow: 1; /* Allow chart container to take available space */
            min-height: 250px; /* Minimum height for the chart drawing area */
            width: 100%;
        }
        /* Canvas itself will be handled by Chart.js responsive settings */


        /* --- Вид "Настройки" --- */
        .settings-section {
            background-color: var(--dark-grey);
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .settings-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--medium-grey);
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--font-grey);
        }

        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            background-color: var(--medium-grey);
            border: 1px solid var(--light-grey);
            border-radius: 6px;
            padding: 10px;
            color: var(--white);
            font-size: 16px;
            box-sizing: border-box; /* Important for width 100% */
        }
         .form-group select option {
            background-color: var(--dark-grey);
        }

        .btn {
            background-color: var(--red);
            color: var(--white);
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s;
        }

        .btn:hover {
            background-color: var(--red-hover);
        }
        .btn:disabled {
            background-color: var(--light-grey);
            cursor: not-allowed;
            opacity: 0.7;
        }


        .btn-secondary {
            background-color: var(--medium-grey);
        }
        .btn-secondary:hover {
            background-color: var(--light-grey);
        }
        .btn-secondary:disabled {
            background-color: var(--dark-grey);
            opacity: 0.5;
        }

        .btn-delete { /* For delete task button */
            background-color: var(--delete-red);
        }
        .btn-delete:hover {
            background-color: var(--delete-red-hover);
        }

        /* --- Модальное окно --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--dark-grey);
            padding: 25px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%; /* Max width for smaller screens */
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            cursor: pointer;
            font-size: 24px;
            color: var(--font-grey);
            transition: color 0.2s;
        }
        .modal-close:hover {
            color: var(--white);
        }

        .modal-date { /* Class for date display in modals */
            color: var(--font-grey);
            margin-bottom: 15px;
        }
        .modal-buttons-container { /* Class for button containers in modals */
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        #priority-select-modal, #day-priority-select-modal {
            width: 100%;
            background-color: var(--medium-grey);
            border: 1px solid var(--light-grey);
            border-radius: 6px;
            padding: 10px;
            color: var(--white);
            font-size: 16px;
        }
         #priority-select-modal option, #day-priority-select-modal option {
             background-color: var(--dark-grey);
         }


        /* --- Страница входа (placeholder) --- */
        #login-view {
            display: flex;
            height: 100vh;
            width: 100vw;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            background-color: var(--black);
            z-index: 2000;
        }

        #login-view.hidden {
            display: none;
        }

        .login-box {
            width: 350px;
            padding: 30px;
            background: var(--dark-grey);
            border-radius: 8px;
        }
        .login-title { /* Class for login title */
            text-align: center;
            margin-bottom: 25px;
        }
        .login-info-text { /* Class for info text */
            font-size: 12px;
            color: var(--font-grey);
            text-align: center;
            margin-top: 15px;
        }


        .hidden {
            display: none !important;
        }

        /* Helper for text alignment */
        .text-center {
            text-align: center;
        }
        .settings-info-text { /* For paragraphs in settings */
            color: var(--font-grey);
            margin-bottom: 20px;
        }
        .settings-telegram-info {
            color: var(--font-grey);
            font-size: 14px;
            margin-bottom: 15px;
        }

    </style>
</head>
<body>

<!-- ЭКРАН ВХОДА (имитация) -->
<div id="login-view">
    <div class="login-box">
        <h2 class="modal-title login-title">Вход в Flowmap</h2>
        <div class="form-group">
            <label for="username">Имя пользователя</label>
            <input type="text" id="username" placeholder="username">
        </div>
        <div class="form-group">
            <label for="password">Пароль</label>
            <input type="password" id="password" placeholder="password (любой)">
        </div>
        <button class="btn" style="width: 100%; margin-top: 10px;" onclick="handleLogin()">Войти / Зарегистрироваться</button>
        <p class="login-info-text">
            Так как это front-end прототип, просто введите любые данные. Они сохранятся в вашем браузере.
        </p>
    </div>
</div>

<!-- ОСНОВНОЕ ПРИЛОЖЕНИЕ -->
<div class="app-wrapper hidden" id="app-container">
    <!-- Боковая панель -->
    <nav class="sidebar">
        <a class="sidebar-link active" data-view="month-view" title="Месяц">
            <svg viewBox="0 0 24 24"><path d="M19,4H18V2H16V4H8V2H6V4H5C3.89,4 3,4.9 3,6V20C3,21.1 3.9,22 5,22H19C20.1,22 21,21.1 21,20V6C21,4.9 20.1,4 19,4M19,20H5V10H19V20M19,8H5V6H19V8M7,12H12V17H7V12Z"/></svg>
        </a>
        <a class="sidebar-link" data-view="year-view" title="Год">
            <svg viewBox="0 0 24 24"><path d="M19 3H18V1H16V3H8V1H6V3H5C3.89 3 3 3.9 3 5V19C3 20.1 3.89 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3M19 19H5V8H19V19M10 10H7V13H10V10M14 10H11V13H14V10M18 10H15V13H18V10M10 14H7V17H10V14M14 14H11V17H14V14M18 14H15V17H18V14Z"/></svg>
        </a>
        <a class="sidebar-link" data-view="stats-view" title="Статистика">
            <svg viewBox="0 0 24 24"><path d="M22,21H2V3H4V17C4,17.55 4.45,18 5,18H19V21H22M19,16H6V1H19C20.1,1 21,1.9 21,3V14C21,15.1 20.1,16 19,16M15,9H13V12H10V7H15V9Z"/></svg>
        </a>
        <a class="sidebar-link" data-view="settings-view" title="Настройки">
            <svg viewBox="0 0 24 24"><path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,19.95L7.44,18.95C7.96,19.34 8.5,19.68 9.13,19.93L9.5,22.58C9.54,22.82 9.75,23 10,23H14C14.25,23 14.46,22.82 14.5,22.58L14.87,19.93C15.5,19.68 16.04,19.34 16.56,18.95L19.05,19.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/></svg>
        </a>
    </nav>

    <!-- Основной контент -->
    <main class="main-content">
        <!-- Раздел: МЕСЯЦ -->
        <div id="month-view" class="view active">
            <div class="view-header">
                <div class="nav-buttons">
                    <button id="prev-month-btn" title="Предыдущий месяц">‹</button>
                    <button id="next-month-btn" title="Следующий месяц">›</button>
                </div>
                <h1 id="month-year-title" class="view-title"></h1>
                <button id="today-btn" class="btn btn-secondary">Сегодня</button>
            </div>
            <div class="calendar-grid-header" id="calendar-weekdays"></div>
            <div class="calendar-grid" id="calendar-body"></div>
        </div>

        <!-- Раздел: ГОД -->
        <div id="year-view" class="view">
            <div class="year-content-wrapper">
                <div class="view-header">
                     <div class="nav-buttons">
                        <button id="prev-year-btn" title="Предыдущий год">‹</button>
                        <button id="next-year-btn" title="Следующий год">›</button>
                    </div>
                    <h1 id="year-title" class="view-title"></h1>
                    <button id="today-year-btn" class="btn btn-secondary">Текущий год</button>
                </div>
                <div class="year-grid" id="year-grid-body"></div>
            </div>
            <aside id="year-goals-panel">
                <h3>Цели на <span id="current-year-goals-span"></span></h3>
                <div id="year-goals-list-container" class="goals-list-container">
                    <!-- Годовые цели будут добавлены сюда JS-ом -->
                </div>
                <div class="form-group"> <!-- No top margin, input has bottom margin -->
                    <input type="text" id="new-year-goal-input" placeholder="Новая годовая цель...">
                </div>
                <button class="btn btn-secondary" id="add-year-goal-btn" style="width:100%;">Добавить цель</button>
                <button class="btn" id="set-priority-for-selected-btn" style="width:100%; margin-top:10px;" disabled>Задать приоритет</button>
            </aside>
        </div>

        <!-- Раздел: СТАТИСТИКА -->
        <div id="stats-view" class="view">
            <div class="view-header">
                <h1 class="view-title">Статистика</h1>
                <div class="nav-buttons">
                    <select id="stats-filter"> <!-- Removed inline style, use CSS -->
                        <option value="30days">За последние 30 дней</option>
                        <option value="thisMonth">Этот месяц</option>
                        <option value="thisQuarter">Этот квартал</option>
                        <option value="thisYear">Этот год</option>
                    </select>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <h2 class="stat-card-title">Коэффициент выполнения задач</h2>
                    <div class="chart-container">
                        <canvas id="completion-rate-chart"></canvas>
                    </div>
                </div>
                <div class="stat-card">
                    <h2 class="stat-card-title">Распределение по приоритетам</h2>
                     <div class="chart-container">
                        <canvas id="priority-dist-chart"></canvas>
                    </div>
                </div>
                <div class="stat-card">
                    <h2 class="stat-card-title">Активность по дням недели (выполненные задачи)</h2>
                    <div class="chart-container">
                        <canvas id="activity-by-day-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Раздел: НАСТРОЙКИ -->
        <div id="settings-view" class="view">
             <h1 class="view-title">Настройки</h1>

            <div class="settings-section">
                <h2 class="settings-title">Интеграция с Telegram (требуется Backend)</h2>
                 <p class="settings-telegram-info">
                    Для отправки уведомлений нужен сервер-посредник. Введите данные вашего бота и URL вашего backend-сервиса.
                </p>
                <div class="form-group">
                    <label for="bot-token">Bot Token</label>
                    <input type="text" id="bot-token" placeholder="Введите токен вашего Telegram бота">
                </div>
                <div class="form-group">
                    <label for="chat-id">Chat ID</label>
                    <input type="text" id="chat-id" placeholder="Введите ваш ID чата в Telegram">
                </div>
                 <div class="form-group">
                    <label for="backend-url">URL Backend-сервиса для Telegram</label>
                    <input type="text" id="backend-url" placeholder="https://your-backend-service.com/send-telegram">
                </div>
                <button class="btn" id="save-telegram-settings">Сохранить</button>
                <button class="btn btn-secondary" id="test-notification-btn" style="margin-left: 10px;">Тестовое уведомление</button>
            </div>

            <div class="settings-section">
                <h2 class="settings-title">Экспорт данных</h2>
                <p class="settings-info-text">Нажмите кнопку ниже, чтобы скачать все ваши задачи и настройки в формате JSON.</p>
                <button class="btn" id="export-data-btn">Экспортировать данные</button>
            </div>
             <div class="settings-section">
                <h2 class="settings-title">Выход</h2>
                <p class="settings-info-text">Выйти из текущего аккаунта.</p>
                <button class="btn btn-secondary" id="logout-btn">Выйти</button>
            </div>
        </div>
    </main>
</div>

<!-- МОДАЛЬНОЕ ОКНО ДЛЯ ДОБАВЛЕНИЯ/РЕДАКТИРОВАНИЯ ЗАДАЧИ -->
<div class="modal" id="task-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="task-modal-title">Новая задача</h2>
            <span class="modal-close" id="task-modal-close-btn">×</span>
        </div>
        <p id="modal-date-display" class="modal-date"></p>
        <input type="hidden" id="task-date-input">
        <input type="hidden" id="task-id-input">

        <div class="form-group">
            <label for="task-title-input">Название</label>
            <input type="text" id="task-title-input" placeholder="Что нужно сделать?">
        </div>
        <div class="form-group">
            <label for="priority-select-modal">Приоритет</label>
            <select id="priority-select-modal">
                <option value="none">Без приоритета</option>
                <option value="red">🔴 Красный (Важный)</option>
                <option value="blue">🔵 Синий (Средний)</option>
                <option value="green">🟢 Зелёный (Простой)</option>
                <option value="yellow">🟡 Желтый (Развлекательный)</option>
            </select>
        </div>
        <div class="modal-buttons-container">
            <button class="btn btn-secondary" id="modal-cancel-btn">Отмена</button>
            <button class="btn" id="modal-save-btn">Сохранить</button>
            <button class="btn btn-delete hidden" id="modal-delete-btn">Удалить</button>
        </div>
    </div>
</div>

<!-- МОДАЛЬНОЕ ОКНО ДЛЯ ВЫБОРА ПРИОРИТЕТА ДНЯ В ГОДОВОМ ВИДЕ -->
<div class="modal" id="day-priority-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Приоритет для выбранных дней</h2>
            <span class="modal-close" id="day-priority-modal-close-btn">×</span>
        </div>
        <p id="day-priority-modal-date-display" class="modal-date"></p>
        <!-- <input type="hidden" id="day-priority-date-input"> // No longer strictly needed for batch, but kept for potential future single use -->

        <div class="form-group">
            <label for="day-priority-select-modal">Цвет приоритета</label>
            <select id="day-priority-select-modal">
                <option value="none">Без приоритета</option>
                <option value="red">🔴 Красный</option>
                <option value="blue">🔵 Синий</option>
                <option value="green">🟢 Зелёный</option>
                <option value="yellow">🟡 Желтый</option>
            </select>
        </div>
        <div class="modal-buttons-container">
            <button class="btn btn-secondary" id="day-priority-modal-cancel-btn">Отмена</button>
            <button class="btn" id="day-priority-modal-save-btn">Сохранить</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- ГЛОБАЛЬНОЕ СОСТОЯНИЕ И КОНСТАНТЫ ---
    let state = {
        user: null,
        currentDate: new Date(),
        tasks: [], // { id, date, title, completed, priority }
        settings: {
            telegram: { token: '', chatId: '', backendUrl: '' }
        },
        annualGoals: {},
        yearDayPriorities: {}, // { "YYYY-MM-DD": "priority_color_key" }
        selectedYearDays: new Set() // For multi-day selection in year view
    };
    let _isBatchDayPriorityMode = false; // Helper flag for day priority modal context

    const monthNames = ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"];
    const dayNamesShort = ["Пн", "Вт", "Ср", "Чт", "Пт", "Сб", "Вс"];
    const dayNamesFull = ["Воскресенье", "Понедельник", "Вторник", "Среда", "Четверг", "Пятница", "Суббота"];

    const priorityColors = { // These are the CSS variable names or direct values like 'transparent'
        red: 'var(--priority-red)',
        blue: 'var(--priority-blue)',
        green: 'var(--priority-green)',
        yellow: 'var(--priority-yellow)',
        none: 'transparent'
    };

    // --- DOM ЭЛЕМЕНТЫ ---
    const sidebarLinks = document.querySelectorAll('.sidebar-link');
    const views = document.querySelectorAll('.view');

    const monthYearTitle = document.getElementById('month-year-title');
    const calendarBody = document.getElementById('calendar-body');
    const calendarWeekdays = document.getElementById('calendar-weekdays');

    const taskModal = document.getElementById('task-modal');
    const taskModalTitle = document.getElementById('task-modal-title');
    const taskModalCloseBtn = document.getElementById('task-modal-close-btn');
    const modalDateDisplay = document.getElementById('modal-date-display');
    const taskDateInput = document.getElementById('task-date-input');
    const taskIdInput = document.getElementById('task-id-input');
    const taskTitleInput = document.getElementById('task-title-input');
    const prioritySelectModal = document.getElementById('priority-select-modal');
    const modalSaveBtn = document.getElementById('modal-save-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const modalDeleteBtn = document.getElementById('modal-delete-btn');

    const yearTitle = document.getElementById('year-title');
    const yearGridBody = document.getElementById('year-grid-body');
    const currentYearGoalsSpan = document.getElementById('current-year-goals-span');
    const todayYearBtn = document.getElementById('today-year-btn');
    const yearGoalsListContainer = document.getElementById('year-goals-list-container');
    const newYearGoalInput = document.getElementById('new-year-goal-input');
    const addYearGoalBtn = document.getElementById('add-year-goal-btn');
    const setPriorityForSelectedBtn = document.getElementById('set-priority-for-selected-btn');


    const dayPriorityModal = document.getElementById('day-priority-modal');
    const dayPriorityModalCloseBtn = document.getElementById('day-priority-modal-close-btn');
    const dayPriorityModalDateDisplay = document.getElementById('day-priority-modal-date-display');
    const dayPrioritySelectModal = document.getElementById('day-priority-select-modal');
    const dayPriorityModalSaveBtn = document.getElementById('day-priority-modal-save-btn');
    const dayPriorityModalCancelBtn = document.getElementById('day-priority-modal-cancel-btn');

    const botTokenInput = document.getElementById('bot-token');
    const chatIdInput = document.getElementById('chat-id');
    const backendUrlInput = document.getElementById('backend-url');

    const usernameInputLogin = document.getElementById('username');
    const passwordInputLogin = document.getElementById('password');
    const statsFilterElement = document.getElementById('stats-filter');


    // --- УПРАВЛЕНИЕ ДАННЫМИ (localStorage) ---
    function saveState() {
        if (state.user) {
            const serializableState = {
                ...state,
                selectedYearDays: Array.from(state.selectedYearDays)
            };
            localStorage.setItem(`flowmap_user_${state.user.username}`, JSON.stringify(serializableState));
        }
    }

    function loadState(username) {
        const savedState = localStorage.getItem(`flowmap_user_${username}`);
        if (savedState) {
            const parsedState = JSON.parse(savedState);
            state = {
                ...state,
                ...parsedState,
                settings: {
                    ...state.settings,
                    ...(parsedState.settings || {})
                },
                annualGoals: parsedState.annualGoals && typeof parsedState.annualGoals === 'object'
                                ? parsedState.annualGoals
                                : {},
                yearDayPriorities: parsedState.yearDayPriorities || {},
                selectedYearDays: new Set(parsedState.selectedYearDays || [])
            };
            state.currentDate = new Date(state.currentDate);
        } else {
            state.tasks = [];
            state.annualGoals = {};
            state.yearDayPriorities = {};
            state.selectedYearDays = new Set();
            state.settings = { telegram: { token: '', chatId: '', backendUrl: '' }};
        }
    }

    // --- ЛОГИКА АУТЕНТИФИКАЦИИ ---
    window.handleLogin = () => {
        const username = usernameInputLogin.value.trim();
        if (!username) {
            alert('Пожалуйста, введите имя пользователя.');
            return;
        }
        state.user = { username: username };
        loadState(username);
        document.getElementById('login-view').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
        localStorage.setItem('flowmap_lastUser', username);
        initApp();
    }

    function attemptLoginOnEnter(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            window.handleLogin();
        }
    }

    if (usernameInputLogin && passwordInputLogin) {
        usernameInputLogin.addEventListener('keypress', attemptLoginOnEnter);
        passwordInputLogin.addEventListener('keypress', attemptLoginOnEnter);
    }

    function checkLogin() {
        const lastUser = localStorage.getItem('flowmap_lastUser');
        if(lastUser) {
            state.user = { username: lastUser };
            loadState(lastUser);
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            initApp();
        } else {
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');
            state = {
                user: null, currentDate: new Date(), tasks: [],
                settings: { telegram: { token: '', chatId: '', backendUrl: '' } },
                annualGoals: {}, yearDayPriorities: {}, selectedYearDays: new Set()
            };
        }
    }

    if (document.getElementById('logout-btn')) {
        document.getElementById('logout-btn').addEventListener('click', () => {
           if(confirm('Вы уверены, что хотите выйти?')) {
                localStorage.removeItem('flowmap_lastUser');
                state = {
                    user: null, currentDate: new Date(), tasks: [],
                    settings: { telegram: { token: '', chatId: '', backendUrl: '' } },
                    annualGoals: {}, yearDayPriorities: {}, selectedYearDays: new Set()
                };
                window.location.reload();
           }
        });
    }

    // --- ВСПОМОГАТЕЛЬНАЯ ФУНКЦИЯ ДЛЯ ПОЛУЧЕНИЯ ЗНАЧЕНИЙ CSS ПЕРЕМЕННЫХ ---
    function getCssVariableValue(variableName) {
        // Если передана строка 'var(--имя)', извлекаем '--имя'
        if (variableName.startsWith('var(')) {
            variableName = variableName.substring(4, variableName.length - 1);
        }
        return getComputedStyle(document.documentElement).getPropertyValue(variableName.trim()).trim();
    }

    // --- ЛОГИКА РЕНДЕРИНГА ---
    function renderMonthCalendar() {
        if (!calendarBody || !monthYearTitle || !calendarWeekdays) return;
        calendarBody.innerHTML = '';
        const year = state.currentDate.getFullYear();
        const month = state.currentDate.getMonth();
        const quarter = Math.floor(month / 3) + 1;
        monthYearTitle.textContent = `${monthNames[month]} ${year}`;
        monthYearTitle.style.color = getCssVariableValue(`--q${quarter}-color`); // Используем getCssVariableValue для установки цвета
        const firstDayOfMonthDate = new Date(year, month, 1);
        const firstDayOfMonthWeekday = firstDayOfMonthDate.getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const adjustedFirstDay = (firstDayOfMonthWeekday === 0) ? 6 : firstDayOfMonthWeekday - 1;

        if (calendarWeekdays.children.length === 0) {
           dayNamesShort.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-header';
                dayEl.textContent = day;
                calendarWeekdays.appendChild(dayEl);
           });
        }

        for (let i = 0; i < adjustedFirstDay; i++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day other-month';
            calendarBody.appendChild(dayEl);
        }

        for (let i = 1; i <= daysInMonth; i++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            const dayDate = new Date(year, month, i);
            const dayOfWeekJs = dayDate.getDay();
            if (dayOfWeekJs === 0 || dayOfWeekJs === 6) dayEl.classList.add('weekend');
            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = i;
            const today = new Date();
            if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) dayEl.classList.add('today');
            dayEl.appendChild(dayNumber);
            const tasksContainer = document.createElement('div');
            tasksContainer.className = 'day-tasks';
            dayEl.appendChild(tasksContainer);
            const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            const dayTasks = state.tasks.filter(t => t.date === dateString);
            dayTasks.forEach(task => tasksContainer.appendChild(createTaskElement(task)));
            dayEl.addEventListener('click', (e) => {
                if (e.target.closest('.task-item') || e.target.closest('.task-checkbox')) return;
                openTaskModal(dateString);
            });
            calendarBody.appendChild(dayEl);
        }
        const totalCells = adjustedFirstDay + daysInMonth;
        const remainingCells = (7 - (totalCells % 7)) % 7;
        for (let i = 0; i < remainingCells; i++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day other-month';
            calendarBody.appendChild(dayEl);
        }
    }

    function createTaskElement(task) {
        const taskEl = document.createElement('div');
        taskEl.className = 'task-item';
        taskEl.dataset.taskId = task.id;
        if (task.completed) taskEl.classList.add('completed');
        // priorityColors[task.priority || 'none'] может быть 'var(--имя-переменной)' или 'transparent'
        const bgColor = priorityColors[task.priority || 'none'];
        taskEl.style.backgroundColor = bgColor === 'transparent' ? bgColor : getCssVariableValue(bgColor);

        const checkbox = document.createElement('div');
        checkbox.className = 'task-checkbox';
        checkbox.addEventListener('click', (e) => { e.stopPropagation(); toggleTaskCompletion(task.id); });
        const title = document.createElement('span');
        title.className = 'task-title';
        title.textContent = task.title;
        taskEl.appendChild(checkbox);
        taskEl.appendChild(title);
        taskEl.addEventListener('click', (e) => {
            if(e.target.classList.contains('task-checkbox')) return;
            e.stopPropagation(); openTaskModal(task.date, task.id);
        });
        return taskEl;
    }

    function renderYearCalendar() {
        if (!yearGridBody || !yearTitle || !currentYearGoalsSpan) return;
        yearGridBody.innerHTML = '';
        const year = state.currentDate.getFullYear();
        const yearString = String(year);
        yearTitle.textContent = yearString;
        currentYearGoalsSpan.textContent = yearString;
        renderAnnualGoalsList(yearString);
        updateBatchPriorityButtonState();

        for (let month = 0; month < 12; month++) {
            const monthCard = document.createElement('div');
            monthCard.className = 'month-card';
            const titleEl = document.createElement('h3');
            titleEl.className = 'month-card-title';
            const quarter = Math.floor(month / 3) + 1;
            titleEl.textContent = monthNames[month];
            titleEl.style.color = getCssVariableValue(`--q${quarter}-color`); // Используем getCssVariableValue
            const daysGrid = document.createElement('div');
            daysGrid.className = 'month-days-grid';
            dayNamesShort.forEach(name => {
                const dayHeader = document.createElement('span');
                dayHeader.textContent = name[0];
                dayHeader.style.color = getCssVariableValue('--font-grey'); // Используем getCssVariableValue
                daysGrid.appendChild(dayHeader);
            });
            const firstDayOfMonthDate = new Date(year, month, 1);
            const firstDayOfMonthWeekday = firstDayOfMonthDate.getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const adjustedFirstDay = (firstDayOfMonthWeekday === 0) ? 6 : firstDayOfMonthWeekday - 1;
            for (let i = 0; i < adjustedFirstDay; i++) {
                const emptyCell = document.createElement('span');
                emptyCell.className = 'month-day-cell empty-day';
                daysGrid.appendChild(emptyCell);
            }
            for (let i = 1; i <= daysInMonth; i++) {
                 const dayCell = document.createElement('span');
                 dayCell.textContent = i;
                 dayCell.className = 'month-day-cell';
                 const today = new Date();
                 if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) dayCell.classList.add('today');
                 const dateString = `${yearString}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                 if (state.yearDayPriorities[dateString]) {
                     const cellBgColor = priorityColors[state.yearDayPriorities[dateString]];
                     dayCell.style.backgroundColor = cellBgColor === 'transparent' ? cellBgColor : getCssVariableValue(cellBgColor);
                     dayCell.classList.add('selected-priority');
                 }
                 if (state.selectedYearDays.has(dateString)) dayCell.classList.add('multi-selected');
                 dayCell.addEventListener('click', () => toggleYearDaySelection(dateString, dayCell));
                 daysGrid.appendChild(dayCell);
            }
            const totalCellsRenderedForMonth = adjustedFirstDay + daysInMonth;
            const remainingGridCells = (7 - (totalCellsRenderedForMonth % 7)) % 7;
            for (let i = 0; i < remainingGridCells; i++) {
                const emptyCell = document.createElement('span');
                emptyCell.className = 'month-day-cell empty-day';
                daysGrid.appendChild(emptyCell);
            }
            monthCard.appendChild(titleEl);
            monthCard.appendChild(daysGrid);
            yearGridBody.appendChild(monthCard);
        }
    }

    function renderAnnualGoalsList(yearStringParam) {
        if (!yearGoalsListContainer) return;
        yearGoalsListContainer.innerHTML = '';
        const goalsForYear = state.annualGoals[yearStringParam] || [];
        if (goalsForYear.length === 0) {
            const placeholder = document.createElement('p');
            placeholder.textContent = 'Целей на этот год пока нет.';
            placeholder.style.color = getCssVariableValue('--font-grey'); // Используем getCssVariableValue
            placeholder.style.textAlign = 'center';
            yearGoalsListContainer.appendChild(placeholder);
            return;
        }
        goalsForYear.forEach(goal => {
            const goalEl = document.createElement('div');
            goalEl.className = 'goal-item';
            goalEl.dataset.goalId = goal.id;
            if (goal.completed) goalEl.classList.add('completed');
            const checkbox = document.createElement('div');
            checkbox.className = 'goal-checkbox';
            checkbox.addEventListener('click', () => toggleAnnualGoal(yearStringParam, goal.id));
            const text = document.createElement('span');
            text.className = 'goal-text';
            text.textContent = goal.text;
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'goal-delete-btn';
            deleteBtn.innerHTML = '×';
            deleteBtn.title = "Удалить цель";
            deleteBtn.addEventListener('click', () => deleteAnnualGoal(yearStringParam, goal.id));
            goalEl.appendChild(checkbox);
            goalEl.appendChild(text);
            goalEl.appendChild(deleteBtn);
            yearGoalsListContainer.appendChild(goalEl);
        });
    }

    if (addYearGoalBtn) {
        addYearGoalBtn.addEventListener('click', () => {
            const yearString = String(state.currentDate.getFullYear());
            const goalText = newYearGoalInput.value.trim();
            if (!goalText) { alert('Введите текст годовой цели.'); newYearGoalInput.focus(); return; }
            if (!state.annualGoals[yearString]) state.annualGoals[yearString] = [];
            const newGoal = { id: `goal_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`, text: goalText, completed: false };
            state.annualGoals[yearString].push(newGoal);
            saveState(); renderAnnualGoalsList(yearString); newYearGoalInput.value = ''; newYearGoalInput.focus();
        });
    }
    if (newYearGoalInput) {
        newYearGoalInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); if (addYearGoalBtn) addYearGoalBtn.click(); }
        });
    }

    function toggleAnnualGoal(yearStringParam, goalId) {
        const goals = state.annualGoals[yearStringParam];
        if (!goals) return;
        const goalIndex = goals.findIndex(g => g.id === goalId);
        if (goalIndex > -1) { goals[goalIndex].completed = !goals[goalIndex].completed; saveState(); renderAnnualGoalsList(yearStringParam); }
    }

    function deleteAnnualGoal(yearStringParam, goalId) {
        if (!confirm('Вы уверены, что хотите удалить эту годовую цель?')) return;
        const goals = state.annualGoals[yearStringParam];
        if (!goals) return;
        state.annualGoals[yearStringParam] = goals.filter(g => g.id !== goalId);
        saveState(); renderAnnualGoalsList(yearStringParam);
    }

    function getTasksForPeriod(tasks, filterValue) {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();
        const currentDate = now.getDate();
        let startDate, endDate;
        endDate = new Date(currentYear, currentMonth, currentDate, 23, 59, 59, 999);
        switch (filterValue) {
            case '30days':
                startDate = new Date(currentYear, currentMonth, currentDate);
                startDate.setDate(startDate.getDate() - 29);
                startDate.setHours(0,0,0,0);
                break;
            case 'thisMonth':
                startDate = new Date(currentYear, currentMonth, 1, 0, 0, 0, 0);
                endDate = new Date(currentYear, currentMonth + 1, 0, 23, 59, 59, 999);
                break;
            case 'thisQuarter':
                const quarterStartMonth = Math.floor(currentMonth / 3) * 3;
                startDate = new Date(currentYear, quarterStartMonth, 1, 0, 0, 0, 0);
                endDate = new Date(currentYear, quarterStartMonth + 3, 0, 23, 59, 59, 999);
                break;
            case 'thisYear':
                startDate = new Date(currentYear, 0, 1, 0, 0, 0, 0);
                endDate = new Date(currentYear, 11, 31, 23, 59, 59, 999);
                break;
            default: return tasks;
        }
        return tasks.filter(task => {
            const [year, month, day] = task.date.split('-').map(Number);
            const taskDate = new Date(year, month - 1, day, 0,0,0,0);
            return taskDate >= startDate && taskDate <= endDate;
        });
    }

    let completionChart, priorityChart, activityByDayChart;

    function renderStatistics() {
        if (!document.getElementById('completion-rate-chart') ||
            !document.getElementById('priority-dist-chart') ||
            !document.getElementById('activity-by-day-chart') ||
            !statsFilterElement) {
            console.warn("Stats elements not found, skipping renderStatistics");
            return;
        }

        const filterValue = statsFilterElement.value;
        const tasksToAnalyze = getTasksForPeriod(state.tasks, filterValue);

        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded.');
            return;
        }

        // --- ИЗМЕНЕНИЯ НАЧИНАЮТСЯ ЗДЕСЬ ---
        // Получаем реальные значения цветов из CSS переменных
        const resolvedColors = {
            priorityRed: getCssVariableValue(priorityColors.red), // priorityColors.red is 'var(--priority-red)'
            priorityBlue: getCssVariableValue(priorityColors.blue),
            priorityGreen: getCssVariableValue(priorityColors.green),
            priorityYellow: getCssVariableValue(priorityColors.yellow),
            mediumGrey: getCssVariableValue('--medium-grey'),
            darkGrey: getCssVariableValue('--dark-grey'),
            lightGrey: getCssVariableValue('--light-grey'),
            barColorRed: getCssVariableValue('--red'), // Solid red for activity chart bars
            barBorderRedHover: getCssVariableValue('--red-hover'),
            white: getCssVariableValue('--white') // For text, ticks, labels
        };
        // --- ИЗМЕНЕНИЯ ЗАКАНЧИВАЮТСЯ ЗДЕСЬ ---


        const ctxCompletion = document.getElementById('completion-rate-chart').getContext('2d');
        const ctxPriority = document.getElementById('priority-dist-chart').getContext('2d');
        const ctxActivity = document.getElementById('activity-by-day-chart').getContext('2d');

        const completedTasks = tasksToAnalyze.filter(t => t.completed).length;
        const totalTasks = tasksToAnalyze.length;
        const pendingTasks = totalTasks - completedTasks;

        const priorityCounts = tasksToAnalyze.reduce((acc, task) => {
            acc[task.priority || 'none'] = (acc[task.priority || 'none'] || 0) + 1;
            return acc;
        }, {});

        const activity = Array(7).fill(0);
        tasksToAnalyze.filter(t => t.completed).forEach(task => {
            const [year, month, day] = task.date.split('-').map(Number);
            const taskDateObj = new Date(year, month - 1, day);
            let dayOfWeek = taskDateObj.getDay();
            dayOfWeek = (dayOfWeek === 0) ? 6 : dayOfWeek - 1;
            activity[dayOfWeek]++;
        });

        if(completionChart) completionChart.destroy();
        completionChart = new Chart(ctxCompletion, {
            type: 'doughnut',
            data: {
                labels: ['Выполнено', 'В ожидании'],
                datasets: [{
                    data: [completedTasks, pendingTasks],
                    // --- ИЗМЕНЕНИЕ: Используем разрешенные цвета ---
                    backgroundColor: [resolvedColors.priorityGreen, resolvedColors.mediumGrey],
                    borderColor: resolvedColors.darkGrey,
                    // --- КОНЕЦ ИЗМЕНЕНИЯ ---
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        // --- ИЗМЕНЕНИЕ: Используем разрешенный цвет ---
                        labels: { color: resolvedColors.white }
                        // --- КОНЕЦ ИЗМЕНЕНИЯ ---
                    }
                }
            }
        });

        if(priorityChart) priorityChart.destroy();
        priorityChart = new Chart(ctxPriority, {
            type: 'pie',
            data: {
                labels: ['🔴 Важные', '🔵 Средние', '🟢 Простые', '🟡 Другие', 'Без приоритета'],
                datasets: [{
                    data: [
                        priorityCounts.red || 0, priorityCounts.blue || 0, priorityCounts.green || 0,
                        priorityCounts.yellow || 0, priorityCounts.none || 0
                    ],
                    // --- ИЗМЕНЕНИЕ: Используем разрешенные цвета ---
                    backgroundColor: [
                        resolvedColors.priorityRed,
                        resolvedColors.priorityBlue,
                        resolvedColors.priorityGreen,
                        resolvedColors.priorityYellow,
                        resolvedColors.lightGrey
                    ],
                    borderColor: resolvedColors.darkGrey,
                    // --- КОНЕЦ ИЗМЕНЕНИЯ ---
                    borderWidth: 2
                }]
            },
             options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        // --- ИЗМЕНЕНИЕ: Используем разрешенный цвет ---
                        labels: { color: resolvedColors.white }
                        // --- КОНЕЦ ИЗМЕНЕНИЯ ---
                    }
                }
            }
        });

        if(activityByDayChart) activityByDayChart.destroy();
        activityByDayChart = new Chart(ctxActivity, {
            type: 'bar',
            data: {
                labels: dayNamesShort,
                 datasets: [{
                    label: 'Выполненных задач', data: activity,
                    // --- ИЗМЕНЕНИЕ: Используем разрешенные цвета ---
                    backgroundColor: resolvedColors.barColorRed,
                    borderColor: resolvedColors.barBorderRedHover,
                    // --- КОНЕЦ ИЗМЕНЕНИЯ ---
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        // --- ИЗМЕНЕНИЕ: Используем разрешенные цвета ---
                        ticks: { color: resolvedColors.white, stepSize: Math.max(1, ...activity) > 10 ? undefined : 1 },
                        grid: { color: resolvedColors.mediumGrey }
                        // --- КОНЕЦ ИЗМЕНЕНИЯ ---
                    },
                    x: {
                        // --- ИЗМЕНЕНИЕ: Используем разрешенные цвета ---
                        ticks: { color: resolvedColors.white },
                        grid: { color: resolvedColors.mediumGrey }
                        // --- КОНЕЦ ИЗМЕНЕНИЯ ---
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    function openTaskModal(date, taskId = null) {
        if (!taskModal || !modalDateDisplay || !taskDateInput || !taskTitleInput || !prioritySelectModal || !taskIdInput || !modalDeleteBtn || !taskModalTitle) return;
        const dateParts = date.split('-');
        const formattedDate = `${dateParts[2]}.${dateParts[1]}.${dateParts[0]}`;
        modalDateDisplay.textContent = `Для: ${formattedDate}`;
        taskDateInput.value = date; taskTitleInput.value = ''; prioritySelectModal.value = 'none'; taskIdInput.value = '';
        modalDeleteBtn.classList.add('hidden');
        if(taskId) {
            const task = state.tasks.find(t => t.id === taskId);
            if(task) { taskModalTitle.textContent = 'Редактировать задачу'; taskTitleInput.value = task.title; prioritySelectModal.value = task.priority || 'none'; taskIdInput.value = task.id; modalDeleteBtn.classList.remove('hidden'); }
        } else { taskModalTitle.textContent = 'Новая задача'; }
        taskModal.classList.add('active'); taskTitleInput.focus();
    }
    if (taskTitleInput) {
        taskTitleInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') { e.preventDefault(); saveTask(); } });
    }

    function closeTaskModal() { if (taskModal) taskModal.classList.remove('active'); }
    function saveTask() {
        if (!taskTitleInput || !taskDateInput || !prioritySelectModal || !taskIdInput) return;
        const title = taskTitleInput.value.trim(); const date = taskDateInput.value; const priority = prioritySelectModal.value; const id = taskIdInput.value;
        if (!title) { alert('Название задачи не может быть пустым.'); taskTitleInput.focus(); return; }
        if (id) {
            const taskIndex = state.tasks.findIndex(t => t.id === id);
            if (taskIndex > -1) { state.tasks[taskIndex].title = title; state.tasks[taskIndex].priority = priority; }
        } else { state.tasks.push({ id: `task_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`, date, title, completed: false, priority }); }
        saveState(); renderMonthCalendar();
        if (document.getElementById('stats-view') && document.getElementById('stats-view').classList.contains('active')) renderStatistics();
        closeTaskModal();
    }
    function deleteTask() {
        if (!taskIdInput) return; const id = taskIdInput.value;
        if(id && confirm('Вы уверены, что хотите удалить эту задачу?')) {
            state.tasks = state.tasks.filter(t => t.id !== id); saveState(); renderMonthCalendar();
            if (document.getElementById('stats-view') && document.getElementById('stats-view').classList.contains('active')) renderStatistics();
            closeTaskModal();
        }
    }
    function toggleTaskCompletion(taskId) {
        const taskIndex = state.tasks.findIndex(t => t.id === taskId);
        if (taskIndex > -1) {
            state.tasks[taskIndex].completed = !state.tasks[taskIndex].completed; saveState(); renderMonthCalendar();
            if (document.getElementById('stats-view') && document.getElementById('stats-view').classList.contains('active')) renderStatistics();
        }
    }

    function toggleYearDaySelection(dateString, dayCellElement) {
        if (state.selectedYearDays.has(dateString)) { state.selectedYearDays.delete(dateString); dayCellElement.classList.remove('multi-selected'); }
        else { state.selectedYearDays.add(dateString); dayCellElement.classList.add('multi-selected'); }
        updateBatchPriorityButtonState();
    }

    function updateBatchPriorityButtonState() {
        if (!setPriorityForSelectedBtn) return;
        const selectedCount = state.selectedYearDays.size;
        if (selectedCount > 0) { setPriorityForSelectedBtn.disabled = false; setPriorityForSelectedBtn.textContent = `Задать приоритет (${selectedCount} дн.)`; }
        else { setPriorityForSelectedBtn.disabled = true; setPriorityForSelectedBtn.textContent = 'Задать приоритет'; }
    }

    function openBatchDayPriorityModal() {
        if (!dayPriorityModal || !dayPriorityModalDateDisplay || !dayPrioritySelectModal || state.selectedYearDays.size === 0) return;
        _isBatchDayPriorityMode = true; const selectedCount = state.selectedYearDays.size;
        dayPriorityModalDateDisplay.textContent = `Для ${selectedCount} выбранных дней`; dayPrioritySelectModal.value = 'none';
        dayPriorityModal.classList.add('active'); dayPrioritySelectModal.focus();
    }

    function closeDayPriorityModal() { if (dayPriorityModal) dayPriorityModal.classList.remove('active'); _isBatchDayPriorityMode = false; }
    function saveDayPriority() {
        if (!dayPrioritySelectModal) return; const priority = dayPrioritySelectModal.value;
        if (_isBatchDayPriorityMode && state.selectedYearDays.size > 0) {
            state.selectedYearDays.forEach(dateString => {
                if (priority && priority !== 'none') state.yearDayPriorities[dateString] = priority;
                else delete state.yearDayPriorities[dateString];
            });
            state.selectedYearDays.clear();
        } else { console.warn("saveDayPriority called in an unexpected state or for single day (which is deprecated path)"); }
        saveState(); renderYearCalendar(); updateBatchPriorityButtonState(); closeDayPriorityModal();
    }

    if (dayPrioritySelectModal) {
        dayPrioritySelectModal.addEventListener('keypress', function(e) { if (e.key === 'Enter') { e.preventDefault(); saveDayPriority(); } });
    }

    sidebarLinks.forEach(link => {
        link.addEventListener('click', () => {
            const viewId = link.getAttribute('data-view');
            sidebarLinks.forEach(l => l.classList.remove('active')); link.classList.add('active');
            views.forEach(v => v.classList.remove('active')); const activeView = document.getElementById(viewId);
            if (activeView) activeView.classList.add('active');
            if(viewId === 'month-view') renderMonthCalendar();
            if(viewId === 'year-view') renderYearCalendar();
            if(viewId === 'stats-view') renderStatistics();
            if(viewId === 'settings-view' && botTokenInput && chatIdInput && backendUrlInput) {
                botTokenInput.value = state.settings.telegram.token || ''; chatIdInput.value = state.settings.telegram.chatId || ''; backendUrlInput.value = state.settings.telegram.backendUrl || '';
            }
        });
    });

    const prevMonthBtn = document.getElementById('prev-month-btn');
    const nextMonthBtn = document.getElementById('next-month-btn');
    const todayBtn = document.getElementById('today-btn');
    if (prevMonthBtn) prevMonthBtn.addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderMonthCalendar(); });
    if (nextMonthBtn) nextMonthBtn.addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderMonthCalendar(); });
    if (todayBtn) todayBtn.addEventListener('click', () => { state.currentDate = new Date(); renderMonthCalendar(); });

    const prevYearBtn = document.getElementById('prev-year-btn');
    const nextYearBtn = document.getElementById('next-year-btn');
    if (prevYearBtn) prevYearBtn.addEventListener('click', () => { state.currentDate.setFullYear(state.currentDate.getFullYear() - 1); state.selectedYearDays.clear(); renderYearCalendar(); });
    if (nextYearBtn) nextYearBtn.addEventListener('click', () => { state.currentDate.setFullYear(state.currentDate.getFullYear() + 1); state.selectedYearDays.clear(); renderYearCalendar(); });
    if (todayYearBtn) todayYearBtn.addEventListener('click', () => { state.currentDate = new Date(); state.selectedYearDays.clear(); renderYearCalendar(); });

    if (taskModalCloseBtn) taskModalCloseBtn.addEventListener('click', closeTaskModal);
    if (modalCancelBtn) modalCancelBtn.addEventListener('click', closeTaskModal);
    if (modalSaveBtn) modalSaveBtn.addEventListener('click', saveTask);
    if (modalDeleteBtn) modalDeleteBtn.addEventListener('click', deleteTask);

    if (dayPriorityModalCloseBtn) dayPriorityModalCloseBtn.addEventListener('click', closeDayPriorityModal);
    if (dayPriorityModalCancelBtn) dayPriorityModalCancelBtn.addEventListener('click', closeDayPriorityModal);
    if (dayPriorityModalSaveBtn) dayPriorityModalSaveBtn.addEventListener('click', saveDayPriority);
    if (setPriorityForSelectedBtn) setPriorityForSelectedBtn.addEventListener('click', openBatchDayPriorityModal);

    if (statsFilterElement) statsFilterElement.addEventListener('change', renderStatistics);

    window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (taskModal && taskModal.classList.contains('active')) closeTaskModal();
            if (dayPriorityModal && dayPriorityModal.classList.contains('active')) closeDayPriorityModal();
        }
    });

    const exportDataBtn = document.getElementById('export-data-btn');
    if (exportDataBtn) {
        exportDataBtn.addEventListener('click', () => {
            const exportState = { ...state, user: undefined, selectedYearDays: Array.from(state.selectedYearDays) };
            const dataStr = JSON.stringify(exportState, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob); const link = document.createElement('a');
            link.href = url; link.download = `flowmap_backup_${state.user ? state.user.username : 'data'}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
            alert('Данные экспортированы.');
        });
    }

    const saveTelegramSettingsBtn = document.getElementById('save-telegram-settings');
    if (saveTelegramSettingsBtn) {
        saveTelegramSettingsBtn.addEventListener('click', () => {
            if (!botTokenInput || !chatIdInput || !backendUrlInput) return;
            state.settings.telegram.token = botTokenInput.value.trim(); state.settings.telegram.chatId = chatIdInput.value.trim(); state.settings.telegram.backendUrl = backendUrlInput.value.trim();
            saveState(); alert('Настройки Telegram сохранены (локально). Для отправки уведомлений требуется настроенный Backend.');
        });
    }

    const testNotificationBtn = document.getElementById('test-notification-btn');
    if (testNotificationBtn) {
        testNotificationBtn.addEventListener('click', async () => {
            const token = state.settings.telegram.token; const chatId = state.settings.telegram.chatId; const backendUrl = state.settings.telegram.backendUrl;
            const message = "Тестовое уведомление от Flowmap! 🤖";
            if (!backendUrl) { alert("Ошибка: URL Backend-сервиса не указан..."); return; }
            if (!token || !chatId) { alert("Ошибка: Token бота или Chat ID не указаны..."); return; }
            try {
                alert(`Попытка отправить тестовое уведомление через ваш Backend: ${backendUrl}...`);
                const response = await fetch(backendUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify({ bot_token: token, chat_id: chatId, message: message, }), });
                const result = await response.json();
                if (response.ok && result.ok) { alert('Тестовое уведомление успешно отправлено (через ваш Backend)!'); }
                else { alert(`Ошибка отправки уведомления (ответ от Backend):\n${result.description || JSON.stringify(result)}`); }
            } catch (error) { console.error('Ошибка при отправке тестового уведомления:', error); alert(`Критическая ошибка при попытке связи с Backend:\n${error.message}...`); }
        });
    }

    function initApp() {
        if (botTokenInput && chatIdInput && backendUrlInput && state.settings && state.settings.telegram) {
            botTokenInput.value = state.settings.telegram.token || ''; chatIdInput.value = state.settings.telegram.chatId || ''; backendUrlInput.value = state.settings.telegram.backendUrl || '';
        }
        const activeSidebarLink = document.querySelector('.sidebar-link.active');
        const activeViewId = activeSidebarLink ? activeSidebarLink.getAttribute('data-view') : 'month-view';
        if (activeViewId === 'month-view') renderMonthCalendar();
        else if (activeViewId === 'year-view') renderYearCalendar();
        else if (activeViewId === 'stats-view') renderStatistics();
        updateBatchPriorityButtonState();
    }
    checkLogin();
});
</script>
</body>
</html>
